name: Python Build and Release

on:
  workflow_dispatch:

  pull_request:
    branches:
    - main

jobs:
  Build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up 32-bit Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8.10'
        architecture: 'x86'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install wxPython

    - name: Build EXE
      run: |
        rm dist -Recurse -Force
        pyinstaller --onefile -w -i Assets\icon.ico CustomTextDisplayTool.py
        pyinstaller -w -i Assets\icon.ico CustomTextDisplayTool.py

    - name: Package onefile EXE
      run: |
        cd dist
        Compress-Archive -Path ./CustomTextDisplayTool.exe -DestinationPath ../CustomTextDisplayTool-Onefile.zip
        echo 'Successfully packaged "CustomTextDisplayTool-Onefile".'

    - name: Upload onefile EXE to GitHub Actions
      uses: actions/upload-artifact@v4
      with:
        name: CustomTextDisplayTool-Onefile
        path: CustomTextDisplayTool-Onefile.zip

    - name: Upload EXE to GitHub Actions
      uses: actions/upload-artifact@v4
      with:
        name: CustomTextDisplayTool
        path: dist/CustomTextDisplayTool/

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        echo "${{ secrets.SSH_SIGNING_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa.pub
        chmod 600 ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa.pub
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git config --global user.signingkey '~/.ssh/id_rsa.pub'
        git config --global gpg.format ssh
        git config --global commit.gpgSign true

    - name: Commit and push the EXE to the repository
      run: |
        rm CustomTextDisplayTool/bin -Recurse -Force
        mkdir -p CustomTextDisplayTool/bin
        cp -r dist/CustomTextDisplayTool/* CustomTextDisplayTool/bin/
        git add dist/CustomTextDisplayTool.exe CustomTextDisplayTool/bin
        git commit -m "Add generated EXE file"
        git push git@github.com:WilsonHuangDev/Custom-Text-Display-Tool.git main
      env:
        GIT_SSH_COMMAND: 'ssh -i ~/.ssh/id_rsa -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'

  Release:
    runs-on: windows-latest

    needs:
      - Build

    steps:
    - uses: actions/checkout@v4
  
    - name: Make dir
      run: |
        mkdir release
        mkdir setup
  
    - name: Download Build Artifact CustomTextDisplayTool-Onefile
      uses: actions/download-artifact@v4.1.8
      with:
        name: CustomTextDisplayTool-Onefile
        path: release

    - name: Copy CustomTextDisplayTool from Repository
      run: |
        cp -r CustomTextDisplayTool setup/
        echo 'Successfully copyed.'

    - name: Install NSIS
      run: |
        'NSIS/nsis-3.08-setup.exe' /S /D=D:\a\Custom-Text-Display-Tool\Custom-Text-Display-Tool\NSIS308
        echo 'Installed successfully.'

    - name: Create Installer
      run: |
        NSIS308/makensis.exe NSIS/CustomTextDisplayTool.nsi
        echo 'Created successfully.'
        cp -r NSIS/CustomTextDisplayTool_Setup.exe release/

    - name: Upload Installer to GitHub Actions
      uses: actions/upload-artifact@v4
      with:
        name: CustomTextDisplayTool-Installer
        path: release/CustomTextDisplayTool_Setup.exe

    - name: Calculate checksums
      run: pwsh .github/workflows/generate-sha256.ps1 release/

    - name: Print files from release dir
      run: ls release

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: |
          release/*.zip
          release/*.exe
        draft: true
        bodyFile: release/checksums.md
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ github.ref_name }}
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
